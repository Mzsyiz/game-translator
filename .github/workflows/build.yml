name: Build Windows Executable

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install system dependencies
      run: |
        choco install ffmpeg -y

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install pyinstaller
        pip install torch torchaudio --index-url https://download.pytorch.org/whl/cpu
        pip install faster-whisper
        pip install PyQt5
        pip install sounddevice numpy scipy
        pip install pyyaml loguru requests
        pip install argostranslate deep-translator
        pip install webrtcvad
        pip install pywin32
        pip install python-dotenv

    - name: Verify installation
      run: |
        python -c "import torch; print('PyTorch:', torch.__version__)"
        python -c "import PyQt5; print('PyQt5: OK')"
        python -c "import faster_whisper; print('faster-whisper: OK')"

    - name: Create necessary directories
      run: |
        if not exist models mkdir models
        if not exist logs mkdir logs
        if not exist release mkdir release
      shell: cmd

    - name: Build executable
      run: |
        python build.py
      continue-on-error: false

    - name: List build output
      run: |
        dir dist
      shell: cmd

    - name: Create release directory
      run: |
        if not exist release mkdir release
        if not exist release\translation mkdir release\translation
        if not exist release\models mkdir release\models
        if not exist release\logs mkdir release\logs

        echo Copying executable directory...
        xcopy /E /I /Y dist\å¯åŠ¨ç¿»è¯‘åŠ©æ‰‹ release\å¯åŠ¨ç¿»è¯‘åŠ©æ‰‹\
        if errorlevel 1 (
          echo ERROR: Failed to copy executable directory
          exit /b 1
        )

        echo Copying config files...
        xcopy /E /I /Y config release\config\
        if errorlevel 1 (
          echo ERROR: Failed to copy config
          exit /b 1
        )

        echo Copying translation files...
        copy /Y translation\slang_dict.json release\translation\
        if errorlevel 1 (
          echo ERROR: Failed to copy slang_dict.json
          exit /b 1
        )

        echo Copying README...
        copy /Y README.md release\
        if errorlevel 1 (
          echo WARNING: README.md not found
        )

        echo Release directory created successfully
      shell: cmd

    - name: Create startup script
      run: |
        echo @echo off > release\å¯åŠ¨ç¿»è¯‘åŠ©æ‰‹.bat
        echo cd /d "%%%%~dp0" >> release\å¯åŠ¨ç¿»è¯‘åŠ©æ‰‹.bat
        echo start "" "å¯åŠ¨ç¿»è¯‘åŠ©æ‰‹\å¯åŠ¨ç¿»è¯‘åŠ©æ‰‹.exe" >> release\å¯åŠ¨ç¿»è¯‘åŠ©æ‰‹.bat
        echo Created startup script
      shell: cmd

    - name: Verify release contents
      run: |
        echo Checking release directory contents...
        dir /S release
      shell: cmd

    - name: Create release archive
      run: |
        $version = "${{ github.ref_name }}"
        if ([string]::IsNullOrEmpty($version)) {
          $version = "latest"
        }
        $zipName = "æ¸¸æˆç¿»è¯‘åŠ©æ‰‹_${version}.zip"
        Write-Host "Creating archive: $zipName"

        Compress-Archive -Path "release\*" -DestinationPath $zipName -Force

        if (Test-Path $zipName) {
          $size = (Get-Item $zipName).Length / 1MB
          Write-Host "Archive created successfully: $([math]::Round($size, 2)) MB"
        } else {
          Write-Error "Failed to create archive"
          exit 1
        }
      shell: powershell

    - name: List release files
      run: |
        echo Listing all zip files:
        dir *.zip
      shell: cmd

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: game-translator-${{ github.run_number }}
        path: "*.zip"
        if-no-files-found: error

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: "*.zip"
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## æ¸¸æˆç¿»è¯‘åŠ©æ‰‹ ${{ github.ref_name }}

          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          1. ä¸‹è½½ `æ¸¸æˆç¿»è¯‘åŠ©æ‰‹_${{ github.ref_name }}.zip`
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. åŒå‡» `å¯åŠ¨ç¿»è¯‘åŠ©æ‰‹.bat` è¿è¡Œ

          ### âœ¨ åŠŸèƒ½ç‰¹æ€§
          - ğŸ® å®æ—¶æ¸¸æˆè¯­éŸ³è¯†åˆ«ä¸ç¿»è¯‘
          - ğŸ¯ æ”¯æŒå¤šç§ç¿»è¯‘å¼•æ“
          - ğŸ”Š é«˜è´¨é‡éŸ³é¢‘å¤„ç†
          - âš™ï¸ çµæ´»çš„é…ç½®é€‰é¡¹

          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Windows 10/11 (64ä½)
          - 4GB+ RAM
          - éº¦å…‹é£è®¾å¤‡
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
